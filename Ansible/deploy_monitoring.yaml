- name: Setup monitoring stack on local machine
  hosts: localhost
  connection: local
  become: true
  become_method: sudo
  become_user: root
  gather_facts: true

  tasks:
    - name: Ensure K3s and ArgoCD script is executable
      file:
        path: "../argocd/configs/setup_k3s_argocd.sh"
        mode: '0755'

    - name: Ensure cAdvisor and Jenkins setup script is executable
      file:
        path: "../prometheus/setup_cadvisor.sh"
        mode: '0755'

    - name: Ensure Node Exporter setup script is executable
      file:
        path: "../prometheus/setup_node_exporter.sh"
        mode: '0755'

    - name: Ensure Grafana setup script is executable
      file:
        path: "../prometheus/setup_grafana.sh"
        mode: '0755'

    - name: Run K3s and ArgoCD setup script
      script: "../argocd/configs/setup_k3s_argocd.sh"
      ignore_errors: yes

    - name: Run cAdvisor and Jenkins setup script
      script: "../prometheus/setup_cadvisor.sh"
      ignore_errors: yes

    - name: Run Node Exporter setup script
      script: "../prometheus/setup_node_exporter.sh"
      ignore_errors: yes

    - name: Run Grafana setup script
      script: "../prometheus/setup_grafana.sh"
      ignore_errors: yes

    - name: Print ArgoCD application details
      ansible.builtin.shell: |
        ARGOCD_DOMAIN="mohamedesmaelargocd.work.gd"
        APP_NAME="comprehensive-production-ci-cd-pipeline-github-actions"
        ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)

        echo "Logging into ArgoCD at ${ARGOCD_DOMAIN}"
        argocd login "${ARGOCD_DOMAIN}" --username admin --password "$ARGOCD_PASSWORD" --insecure --grpc-web || true

        echo "=== APP GET ==="
        argocd app get "${APP_NAME}"

        echo "=== APP HISTORY ==="
        argocd app history "${APP_NAME}"

        echo "=== APP DIFF ==="
        argocd app diff "${APP_NAME}"

        echo "=== APP EVENTS ==="
        argocd app events "${APP_NAME}"
      register: argocd_app_info
      changed_when: false

    - name: Show ArgoCD application output
      debug:
        var: argocd_app_info.stdout_lines
