# /etc/apache2/sites-available/jenkins-ssl.conf

# 1️⃣ Redirect all HTTP to HTTPS
<VirtualHost *:80>
    ServerName mohamedesmael.work.gd

    RewriteEngine On
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

# 2️⃣ ECDSA Certificate VirtualHost
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName mohamedesmael.work.gd

    SSLEngine on
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder on
    SSLCompression off

    # ECDSA cert from Let's Encrypt
    SSLCertificateFile      /etc/letsencrypt/live/mohamedesmael.work.gd/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/mohamedesmael.work.gd/privkey.pem
    Include                 /etc/letsencrypt/options-ssl-apache.conf

    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

    ProxyPreserveHost On
    AllowEncodedSlashes NoDecode

    <Proxy "http://127.0.0.1:8080/">
        Require all granted
    </Proxy>

    ProxyPass        "/"  "http://127.0.0.1:8080/"  retry=0
    ProxyPassReverse "/"  "http://127.0.0.1:8080/"

    RequestHeader set     X-Forwarded-Proto "https"
    RequestHeader set     X-Real-IP          %{REMOTE_ADDR}e
    RequestHeader append  X-Forwarded-For    %{REMOTE_ADDR}e

    ErrorLog   /var/log/apache2/jenkins-ecdsa.error.log
    CustomLog  /var/log/apache2/jenkins-ecdsa.access.log combined
</VirtualHost>
</IfModule>

# 3️⃣ RSA Certificate VirtualHost
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName mohamedesmael.work.gd

    SSLEngine on
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder on
    SSLCompression off

    # RSA cert from Let's Encrypt
    SSLCertificateFile      /etc/letsencrypt/live/mohamedesmael.work.gd-rsa/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/mohamedesmael.work.gd-rsa/privkey.pem
    Include                 /etc/letsencrypt/options-ssl-apache.conf

    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

    ProxyPreserveHost On
    AllowEncodedSlashes NoDecode

    <Proxy "http://127.0.0.1:8080/">
        Require all granted
    </Proxy>

    ProxyPass        "/"  "http://127.0.0.1:8080/"  retry=0
    ProxyPassReverse "/"  "http://127.0.0.1:8080/"

    RequestHeader set     X-Forwarded-Proto "https"
    RequestHeader set     X-Real-IP          %{REMOTE_ADDR}e
    RequestHeader append  X-Forwarded-For    %{REMOTE_ADDR}e

    ErrorLog   /var/log/apache2/jenkins-rsa.error.log
    CustomLog  /var/log/apache2/jenkins-rsa.access.log combined
</VirtualHost>
</IfModule>

